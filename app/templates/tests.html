{% extends "base.html" %}

{% block title %}Testes - Security Checklist{% endblock %}

{% block breadcrumb %}
<a href="/">Dashboard</a>
<span>/</span>
<span class="current">Testes Automatizados</span>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1 class="page-title">Testes Automatizados</h1>
        <p class="page-subtitle">Execute e monitore os testes de segurança automatizados</p>
    </div>
</div>

<!-- Test Execution Panel -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-play-circle" style="color: var(--accent-primary);"></i>
            Executar Testes
        </h2>
    </div>
    <div style="padding: 24px;">
        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
            <div class="form-group" style="margin: 0; flex: 1; min-width: 250px;">
                <label class="form-label">Aplicação</label>
                <select class="form-select" id="testAppSelect">
                    <option value="">Selecione uma aplicação...</option>
                </select>
            </div>
            <div class="form-group" style="margin: 0; min-width: 200px;">
                <label class="form-label">Categoria (opcional)</label>
                <select class="form-select" id="testCategorySelect">
                    <option value="">Todas com teste automatizado</option>
                </select>
            </div>
            <button class="btn btn-primary btn-lg" id="runTestsBtn" disabled onclick="runBatchTests()">
                <i class="fas fa-play"></i>
                <span>Executar Testes</span>
            </button>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" style="display: none; margin-top: 24px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span id="progressLabel">Executando testes...</span>
                <span id="progressCount">0/0</span>
            </div>
            <div style="background: var(--bg-tertiary); border-radius: 10px; height: 10px; overflow: hidden;">
                <div id="progressBar" style="background: var(--accent-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>

        <!-- App Info -->
        <div id="appInfo" style="display: none; margin-top: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--border-radius);">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary);">Nome</label>
                    <p id="appName" style="font-weight: 500;"></p>
                </div>
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary);">URL Base</label>
                    <p id="appUrl" style="font-family: monospace;"></p>
                </div>
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary);">Ambiente</label>
                    <p id="appEnv"></p>
                </div>
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary);">Testes Disponíveis</label>
                    <p id="appTestCount" style="color: var(--accent-primary);"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Summary -->
<div id="resultsSection" style="display: none; margin-top: 20px;">
    <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
        <div class="stat-card" style="padding: 16px;">
            <div class="stat-content">
                <div class="stat-icon" style="background: rgba(255, 215, 0, 0.1); color: var(--accent-primary);">
                    <i class="fas fa-flask"></i>
                </div>
                <div>
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <div class="stat-content">
                <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1); color: var(--success);">
                    <i class="fas fa-check"></i>
                </div>
                <div>
                    <div class="stat-value" id="passTests">0</div>
                    <div class="stat-label">Passou</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <div class="stat-content">
                <div class="stat-icon" style="background: rgba(231, 76, 60, 0.1); color: var(--danger);">
                    <i class="fas fa-times"></i>
                </div>
                <div>
                    <div class="stat-value" id="failTests">0</div>
                    <div class="stat-label">Falhou</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <div class="stat-content">
                <div class="stat-icon" style="background: rgba(241, 196, 15, 0.1); color: var(--warning);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div>
                    <div class="stat-value" id="warnTests">0</div>
                    <div class="stat-label">Alerta</div>
                </div>
            </div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <div class="stat-content">
                <div class="stat-icon" style="background: rgba(149, 165, 166, 0.1); color: var(--text-muted);">
                    <i class="fas fa-ban"></i>
                </div>
                <div>
                    <div class="stat-value" id="skipTests">0</div>
                    <div class="stat-label">Pulou</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Executions -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-history" style="color: var(--accent-primary);"></i>
            Execuções Recentes
        </h2>
    </div>
    <div id="recentExecutions">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</div>

<!-- Test Execution Results -->
<div class="card" style="margin-top: 20px;">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-list-check" style="color: var(--accent-primary);"></i>
            Resultados Detalhados
        </h2>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary btn-sm filter-btn active" data-filter="all">Todos</button>
            <button class="btn btn-secondary btn-sm filter-btn" data-filter="pass">Passou</button>
            <button class="btn btn-secondary btn-sm filter-btn" data-filter="fail">Falhou</button>
            <button class="btn btn-secondary btn-sm filter-btn" data-filter="warning">Alerta</button>
        </div>
    </div>
    <div id="testResults">
        <div class="empty-state">
            <i class="fas fa-vial"></i>
            <h3>Nenhum teste executado</h3>
            <p>Selecione uma aplicação e execute os testes</p>
        </div>
    </div>
</div>

<!-- Test Detail Modal -->
<div class="modal-overlay" id="testDetailModal">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title" id="testDetailTitle">Detalhes do Teste</h3>
            <button class="modal-close" onclick="closeModal('testDetailModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="testDetailBody">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let testResults = [];
    let currentFilter = 'all';

    async function loadInitialData() {
        // Load applications
        const apps = await App.api('/api/applications');
        const appSelect = document.getElementById('testAppSelect');
        apps.forEach(app => {
            const option = document.createElement('option');
            option.value = app.id;
            option.textContent = `${app.name} (${app.environment.toUpperCase()})`;
            option.dataset.url = app.base_url;
            option.dataset.env = app.environment;
            appSelect.appendChild(option);
        });

        // Load categories
        const categories = await App.api('/api/categories');
        const catSelect = document.getElementById('testCategorySelect');
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = `${cat.code} - ${cat.name}`;
            catSelect.appendChild(option);
        });

        // Load recent executions
        loadRecentExecutions();
    }

    async function loadRecentExecutions() {
        const container = document.getElementById('recentExecutions');
        
        try {
            const executions = await App.api('/api/tests/recent');
            
            if (!executions || executions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Nenhuma execução recente</h3>
                        <p>Execute um teste para ver o histórico aqui</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Aplicação</th>
                            <th>Controle</th>
                            <th>Resultado</th>
                            <th>Duração</th>
                            <th>Executado por</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${executions.map(e => `
                            <tr onclick="showTestDetail(${JSON.stringify(e).replace(/"/g, '&quot;')})" style="cursor: pointer;">
                                <td>${App.formatDate(e.executed_at)}</td>
                                <td>${App.escapeHtml(e.application_name || '-')}</td>
                                <td><code style="color: var(--accent-primary);">${e.check_code || '-'}</code></td>
                                <td>
                                    <span class="badge ${getResultClass(e.result)}">
                                        ${getResultLabel(e.result)}
                                    </span>
                                </td>
                                <td>${e.duration_ms ? e.duration_ms + 'ms' : '-'}</td>
                                <td>${App.escapeHtml(e.executed_by_username || 'Sistema')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger" style="margin: 20px;">Erro ao carregar execuções: ${error.message}</div>`;
        }
    }

    async function loadAppInfo(appId) {
        if (!appId) {
            document.getElementById('appInfo').style.display = 'none';
            document.getElementById('runTestsBtn').disabled = true;
            return;
        }

        try {
            const app = await App.api(`/api/applications/${appId}`);
            const checks = await App.api('/api/checks?has_test=true');
            
            document.getElementById('appName').textContent = app.name;
            document.getElementById('appUrl').textContent = app.base_url;
            document.getElementById('appEnv').textContent = app.environment.toUpperCase();
            document.getElementById('appTestCount').textContent = checks.length + ' controles';
            
            document.getElementById('appInfo').style.display = 'block';
            document.getElementById('runTestsBtn').disabled = false;
        } catch (error) {
            App.toast('Erro ao carregar informações da aplicação', 'error');
        }
    }

    async function runBatchTests() {
        const appId = document.getElementById('testAppSelect').value;
        const categoryId = document.getElementById('testCategorySelect').value;
        
        if (!appId) {
            App.toast('Selecione uma aplicação', 'warning');
            return;
        }

        const btn = document.getElementById('runTestsBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando...';

        try {
            // Get checks with automated tests
            let checksUrl = '/api/checks?has_test=true';
            if (categoryId) {
                checksUrl += `&category_id=${categoryId}`;
            }
            const checks = await App.api(checksUrl);

            if (checks.length === 0) {
                App.toast('Nenhum teste automatizado disponível', 'warning');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Executar Testes';
                return;
            }

            // Show progress
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            
            testResults = [];
            let completed = 0;
            const total = checks.length;

            // Reset stats
            updateResultStats();

            // Execute tests sequentially
            for (const check of checks) {
                document.getElementById('progressLabel').textContent = `Testando: ${check.code}`;
                
                try {
                    const result = await App.api('/api/tests/execute', {
                        method: 'POST',
                        body: JSON.stringify({
                            application_id: parseInt(appId),
                            check_id: check.id
                        })
                    });
                    
                    testResults.push({
                        check_code: check.code,
                        check_title: check.title,
                        severity: check.severity,
                        ...result
                    });
                } catch (error) {
                    testResults.push({
                        check_code: check.code,
                        check_title: check.title,
                        severity: check.severity,
                        result: 'error',
                        output: error.message,
                        executed_at: new Date().toISOString()
                    });
                }

                completed++;
                document.getElementById('progressCount').textContent = `${completed}/${total}`;
                document.getElementById('progressBar').style.width = `${(completed / total) * 100}%`;
                
                updateResultStats();
                renderTestResults();
            }

            document.getElementById('progressLabel').textContent = 'Testes concluídos!';
            App.toast(`${total} testes executados`, 'success');
            
            // Reload recent executions
            loadRecentExecutions();

        } catch (error) {
            App.toast('Erro ao executar testes: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Executar Testes';
        }
    }

    function updateResultStats() {
        const stats = {
            total: testResults.length,
            pass: testResults.filter(r => r.result === 'pass').length,
            fail: testResults.filter(r => r.result === 'fail').length,
            warning: testResults.filter(r => r.result === 'warning').length,
            skip: testResults.filter(r => r.result === 'skip' || r.result === 'error').length
        };

        document.getElementById('totalTests').textContent = stats.total;
        document.getElementById('passTests').textContent = stats.pass;
        document.getElementById('failTests').textContent = stats.fail;
        document.getElementById('warnTests').textContent = stats.warning;
        document.getElementById('skipTests').textContent = stats.skip;
    }

    function renderTestResults() {
        const container = document.getElementById('testResults');
        
        let filtered = testResults;
        if (currentFilter !== 'all') {
            filtered = testResults.filter(r => {
                if (currentFilter === 'pass') return r.result === 'pass';
                if (currentFilter === 'fail') return r.result === 'fail';
                if (currentFilter === 'warning') return r.result === 'warning';
                return true;
            });
        }

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 40px;">
                    <i class="fas fa-filter"></i>
                    <h3>Nenhum resultado</h3>
                    <p>Nenhum teste corresponde ao filtro selecionado</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th style="width: 100px;">Código</th>
                        <th>Controle</th>
                        <th style="width: 100px;">Severidade</th>
                        <th style="width: 100px;">Resultado</th>
                        <th style="width: 100px;">Duração</th>
                        <th style="width: 80px;">Detalhes</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map(r => `
                        <tr class="${r.result === 'fail' ? 'row-danger' : r.result === 'warning' ? 'row-warning' : ''}">
                            <td><code style="color: var(--accent-primary);">${r.check_code}</code></td>
                            <td>
                                <span style="font-weight: 500;">${App.escapeHtml(r.check_title)}</span>
                            </td>
                            <td>
                                <span class="badge ${App.getSeverityClass(r.severity)}">
                                    ${App.getSeverityLabel(r.severity)}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${getResultClass(r.result)}">
                                    ${getResultLabel(r.result)}
                                </span>
                            </td>
                            <td>${r.duration_ms ? r.duration_ms + 'ms' : '-'}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick='showTestDetail(${JSON.stringify(r)})'>
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function showTestDetail(result) {
        const modal = document.getElementById('testDetailModal');
        document.getElementById('testDetailTitle').textContent = `${result.check_code} - ${result.check_title || 'Resultado do Teste'}`;
        
        document.getElementById('testDetailBody').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary); display: block;">Resultado</label>
                    <span class="badge ${getResultClass(result.result)}" style="font-size: 14px; margin-top: 4px;">
                        ${getResultLabel(result.result)}
                    </span>
                </div>
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary); display: block;">Duração</label>
                    <span style="font-weight: 500;">${result.duration_ms ? result.duration_ms + 'ms' : 'N/A'}</span>
                </div>
                <div>
                    <label style="font-size: 12px; color: var(--text-secondary); display: block;">Executado em</label>
                    <span style="font-weight: 500;">${result.executed_at ? App.formatDate(result.executed_at) : 'N/A'}</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Saída do Teste</label>
                <pre style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--border-radius); font-size: 13px; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto;">${App.escapeHtml(result.output || 'Sem saída')}</pre>
            </div>

            ${result.details ? `
                <div class="form-group">
                    <label class="form-label">Detalhes Técnicos</label>
                    <pre style="background: var(--bg-tertiary); padding: 16px; border-radius: var(--border-radius); font-size: 12px; white-space: pre-wrap;">${App.escapeHtml(JSON.stringify(result.details, null, 2))}</pre>
                </div>
            ` : ''}
        `;
        
        modal.classList.add('active');
    }

    function getResultClass(result) {
        switch(result) {
            case 'pass': return 'badge-success';
            case 'fail': return 'badge-danger';
            case 'warning': return 'badge-warning';
            case 'skip': return 'badge-neutral';
            case 'error': return 'badge-danger';
            default: return 'badge-neutral';
        }
    }

    function getResultLabel(result) {
        switch(result) {
            case 'pass': return 'Passou';
            case 'fail': return 'Falhou';
            case 'warning': return 'Alerta';
            case 'skip': return 'Pulou';
            case 'error': return 'Erro';
            default: return result || 'N/A';
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // Event Listeners
    document.getElementById('testAppSelect').addEventListener('change', (e) => loadAppInfo(e.target.value));

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderTestResults();
        });
    });

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
            }
        });
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', loadInitialData);
</script>

<style>
    .row-danger {
        background: rgba(231, 76, 60, 0.1);
    }
    .row-warning {
        background: rgba(241, 196, 15, 0.1);
    }
</style>
{% endblock %}
