{% extends "base.html" %}

{% block title %}Aplicações - Security Checklist{% endblock %}

{% block breadcrumb %}
<a href="/">Dashboard</a>
<span>/</span>
<span class="current">Aplicações</span>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1 class="page-title">Aplicações</h1>
        <p class="page-subtitle">Gerencie as aplicações que serão avaliadas</p>
    </div>
    <button class="btn btn-primary" onclick="openModal('createAppModal')">
        <i class="fas fa-plus"></i>
        <span>Nova Aplicação</span>
    </button>
</div>

<!-- Filters -->
<div class="card" style="padding: 16px;">
    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
        <div class="search-box" style="flex: 1; min-width: 200px;">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar aplicações..." style="width: 100%;">
        </div>
        <select class="form-select" id="envFilter" style="width: auto;">
            <option value="">Todos os Ambientes</option>
            <option value="dev">Desenvolvimento</option>
            <option value="hml">Homologação</option>
            <option value="prod">Produção</option>
        </select>
    </div>
</div>

<!-- Applications Grid -->
<div id="appsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 20px;">
    <div class="loading" style="grid-column: 1 / -1;">
        <div class="spinner"></div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal-overlay" id="createAppModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Nova Aplicação</h3>
            <button class="modal-close" onclick="closeModal('createAppModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="appForm">
                <input type="hidden" id="appId">
                
                <div class="form-group">
                    <label class="form-label" for="appName">Nome *</label>
                    <input type="text" class="form-input" id="appName" required placeholder="Ex: Sistema de Vendas">
                </div>

                <div class="form-group">
                    <label class="form-label" for="appDescription">Descrição</label>
                    <textarea class="form-textarea" id="appDescription" placeholder="Descreva a aplicação..." rows="3"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label" for="appEnv">Ambiente</label>
                        <select class="form-select" id="appEnv">
                            <option value="dev">Desenvolvimento</option>
                            <option value="hml">Homologação</option>
                            <option value="prod">Produção</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="appResponsible">Responsável</label>
                        <input type="text" class="form-input" id="appResponsible" placeholder="Nome do responsável">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="appBaseUrl">URL Base</label>
                    <input type="url" class="form-input" id="appBaseUrl" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label class="form-label" for="appTags">Tags</label>
                    <input type="text" class="form-input" id="appTags" placeholder="api, web, mobile (separadas por vírgula)">
                </div>

                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 24px 0;">
                <h4 style="margin-bottom: 16px; font-size: 16px;">Escopo do Teste</h4>

                <div class="form-group">
                    <label class="form-label" for="scopeUrls">URLs em Escopo</label>
                    <textarea class="form-textarea" id="scopeUrls" placeholder="Uma URL por linha" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="scopeEndpoints">Endpoints</label>
                    <textarea class="form-textarea" id="scopeEndpoints" placeholder="Ex: /api/v1/*, /admin/*" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="scopeCredHint">Dica de Credenciais</label>
                    <input type="text" class="form-input" id="scopeCredHint" placeholder="Ex: Solicitar ao time de testes">
                    <small style="color: var(--text-muted); font-size: 12px;">Nunca armazene senhas aqui!</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="scopeNotes">Observações</label>
                    <textarea class="form-textarea" id="scopeNotes" placeholder="Outras informações relevantes" rows="2"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createAppModal')">Cancelar</button>
            <button class="btn btn-primary" onclick="saveApp()">
                <i class="fas fa-save"></i>
                <span>Salvar</span>
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Confirmar Exclusão</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Tem certeza que deseja excluir a aplicação <strong id="deleteAppName"></strong>?</p>
            <p style="color: var(--danger); margin-top: 10px;">Esta ação não pode ser desfeita!</p>
            <input type="hidden" id="deleteAppId">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Cancelar</button>
            <button class="btn btn-danger" onclick="confirmDelete()">
                <i class="fas fa-trash"></i>
                <span>Excluir</span>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let applications = [];

    async function loadApplications() {
        try {
            applications = await App.api('/api/applications');
            renderApplications();
        } catch (error) {
            console.error('Error loading applications:', error);
            App.toast('Erro ao carregar aplicações', 'error');
        }
    }

    function renderApplications() {
        const grid = document.getElementById('appsGrid');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const envFilter = document.getElementById('envFilter').value;

        let filtered = applications.filter(app => {
            const matchSearch = !search || 
                app.name.toLowerCase().includes(search) ||
                (app.description && app.description.toLowerCase().includes(search)) ||
                (app.tags && app.tags.toLowerCase().includes(search));
            const matchEnv = !envFilter || app.environment === envFilter;
            return matchSearch && matchEnv;
        });

        if (filtered.length === 0) {
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-layer-group"></i>
                    <h3>Nenhuma aplicação encontrada</h3>
                    <p>${applications.length === 0 ? 'Crie sua primeira aplicação para começar' : 'Tente ajustar os filtros'}</p>
                    ${applications.length === 0 ? '<button class="btn btn-primary" onclick="openModal(\'createAppModal\')"><i class="fas fa-plus"></i> Nova Aplicação</button>' : ''}
                </div>
            `;
            return;
        }

        grid.innerHTML = filtered.map(app => `
            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">
                                <a href="/applications/${app.id}" style="color: var(--text-primary); text-decoration: none;">
                                    ${App.escapeHtml(app.name)}
                                </a>
                            </h3>
                            <span class="badge badge-${app.environment === 'prod' ? 'danger' : app.environment === 'hml' ? 'warning' : 'info'}">
                                ${app.environment.toUpperCase()}
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="editApp(${app.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteApp(${app.id}, '${App.escapeHtml(app.name)}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${app.description ? `<p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; line-height: 1.5;">${App.escapeHtml(app.description)}</p>` : ''}
                    
                    ${app.base_url ? `
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                            <i class="fas fa-link" style="width: 16px;"></i>
                            <a href="${app.base_url}" target="_blank" style="color: var(--accent-primary);">${App.escapeHtml(app.base_url)}</a>
                        </div>
                    ` : ''}
                    
                    ${app.responsible ? `
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                            <i class="fas fa-user" style="width: 16px;"></i>
                            ${App.escapeHtml(app.responsible)}
                        </div>
                    ` : ''}
                    
                    ${app.tags ? `
                        <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px;">
                            ${app.tags.split(',').map(tag => `
                                <span style="background: var(--bg-tertiary); padding: 2px 8px; border-radius: 4px; font-size: 11px; color: var(--text-secondary);">
                                    ${App.escapeHtml(tag.trim())}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div style="padding: 16px 20px; background: var(--bg-tertiary); border-top: 1px solid var(--border-color); display: flex; gap: 12px;">
                    <a href="/checklist?app=${app.id}" class="btn btn-primary btn-sm" style="flex: 1;">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Checklist</span>
                    </a>
                    <a href="/tests?app=${app.id}" class="btn btn-secondary btn-sm" style="flex: 1;">
                        <i class="fas fa-vial"></i>
                        <span>Testes</span>
                    </a>
                    <a href="/reports?app=${app.id}" class="btn btn-secondary btn-sm" style="flex: 1;">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relatório</span>
                    </a>
                </div>
            </div>
        `).join('');
    }

    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        if (modalId === 'createAppModal') {
            document.getElementById('modalTitle').textContent = 'Nova Aplicação';
            document.getElementById('appForm').reset();
            document.getElementById('appId').value = '';
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    async function editApp(id) {
        try {
            const app = await App.api(`/api/applications/${id}`);
            
            document.getElementById('modalTitle').textContent = 'Editar Aplicação';
            document.getElementById('appId').value = app.id;
            document.getElementById('appName').value = app.name;
            document.getElementById('appDescription').value = app.description || '';
            document.getElementById('appEnv').value = app.environment;
            document.getElementById('appResponsible').value = app.responsible || '';
            document.getElementById('appBaseUrl').value = app.base_url || '';
            document.getElementById('appTags').value = app.tags || '';
            document.getElementById('scopeUrls').value = app.scope_urls || '';
            document.getElementById('scopeEndpoints').value = app.scope_endpoints || '';
            document.getElementById('scopeCredHint').value = app.scope_credentials_hint || '';
            document.getElementById('scopeNotes').value = app.scope_notes || '';
            
            openModal('createAppModal');
        } catch (error) {
            App.toast('Erro ao carregar aplicação', 'error');
        }
    }

    async function saveApp() {
        const id = document.getElementById('appId').value;
        const data = {
            name: document.getElementById('appName').value,
            description: document.getElementById('appDescription').value || null,
            environment: document.getElementById('appEnv').value,
            responsible: document.getElementById('appResponsible').value || null,
            base_url: document.getElementById('appBaseUrl').value || null,
            tags: document.getElementById('appTags').value || null,
            scope_urls: document.getElementById('scopeUrls').value || null,
            scope_endpoints: document.getElementById('scopeEndpoints').value || null,
            scope_credentials_hint: document.getElementById('scopeCredHint').value || null,
            scope_notes: document.getElementById('scopeNotes').value || null
        };

        if (!data.name) {
            App.toast('Nome é obrigatório', 'warning');
            return;
        }

        try {
            if (id) {
                await App.api(`/api/applications/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                App.toast('Aplicação atualizada com sucesso', 'success');
            } else {
                await App.api('/api/applications', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                App.toast('Aplicação criada com sucesso', 'success');
            }
            
            closeModal('createAppModal');
            loadApplications();
        } catch (error) {
            App.toast(error.message || 'Erro ao salvar aplicação', 'error');
        }
    }

    function deleteApp(id, name) {
        document.getElementById('deleteAppId').value = id;
        document.getElementById('deleteAppName').textContent = name;
        openModal('deleteModal');
    }

    async function confirmDelete() {
        const id = document.getElementById('deleteAppId').value;
        
        try {
            await App.api(`/api/applications/${id}`, { method: 'DELETE' });
            App.toast('Aplicação excluída com sucesso', 'success');
            closeModal('deleteModal');
            loadApplications();
        } catch (error) {
            App.toast(error.message || 'Erro ao excluir aplicação', 'error');
        }
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', renderApplications);
    document.getElementById('envFilter').addEventListener('change', renderApplications);

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.classList.remove('active');
            }
        });
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', loadApplications);
</script>
{% endblock %}
